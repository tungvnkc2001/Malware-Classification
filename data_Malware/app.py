from tkinter import *
import os
from tkinter import messagebox


from main import createRawCSV
from main import get_file
from tkinter import Tk, filedialog
from main import scanFolder
from PIL import ImageTk, Image

from XuLy import handleClassifier
from XuLy import ScanVirus

window = Tk()

window.geometry("500x300")

window.title("Extract PE header trong các file .exe và .dll")

open_file = ""

#label_thuMucMuonQuet = Label(window, text = "Nhập thư mục muốn quét", font = ("Arial", 10))
#label_thuMucMuonQuet.grid(row = 1, column = 0)

def BtnThuMucSeQuet():
	open_file = filedialog.askdirectory()
	return open_file

#Btn_ThuMucSeQuet = Button(window, text = "Chọn thư mục sẽ quét", command = BtnThuMucSeQuet)
#Btn_ThuMucSeQuet.grid(row = 1, column = 0)

#input_thuMuc = Entry(window, width = 30)
#input_thuMuc.place(x = 200, y = 0)
#input_thuMuc.grid(row = 1, column = 1)

label_ThongBaoMoThuMuc = Label(window, text = "")
label_ThongBaoMoThuMuc.grid(row = 4, column = 1)

label_trangThai = Label(window, text = "Trạng thái: waiting")
label_trangThai.grid(row = 0, column = 1)


def BtnQuetClick():
	folder = filedialog.askdirectory()
	if os.path.isdir(folder):
		label_ThongBaoMoThuMuc.configure(text = "Mở Folder thành công")
		label_ThongBaoMoThuMuc.grid(row = 5, column = 1)

		#listFile = Listbox(window)
		#i = 1
		#for filename in os.listdir(folder):
		#	listFile.insert(i, filename)

		#listFile.grid(row = 5, column = 0)


		answer = messagebox.askyesno("", "Bạn có muốn bắt đầu phân tích và lưu thông tin của file trong folder " + folder + " ?" )

		if answer:
			if("data.csv" not in os.listdir(os.getcwd())):
				answer = messagebox.askyesno("", "Không tìm được file data.csv để lưu dữ liệu, tạo file mới?")
				if answer:
					createRawCSV()
				else:
					return

			for file_name in os.listdir(folder):
				#state = "Trạng thái: đang scan: " + os.path.join(folder, file_name) 
				#label_trangThai.configure(text = state)
				#label_trangThai.grid(row = 0, column = 1)

				#print(os.path.isdir(os.path.join(folder, file_name)))
				if os.path.isdir(os.path.join(folder, file_name)):
					scanFolder(os.path.join(folder, file_name))
					#print("scan folder " + file_name)
				else:
					get_file(os.path.join(folder, file_name))
				#get_file(os.path.join(folder, file_name))

				state = "Trạng thái: Đã scan xong " + folder
				label_trangThai.configure(text = state)

	else:
		label_ThongBaoMoThuMuc.configure(text = "Folder Không tồn tại")
	#	label_ThongBaoMoThuMuc.grid(row = 2, column = 1)

#def BtnRaCsvAction():



BtnQuet = Button(window, text = "Bắt đầu quét", command = BtnQuetClick)
BtnQuet.grid(row = 0, column = 0)


def XuLyCSV():
	if "data.csv" in (os.listdir(os.getcwd())):
		answer = messagebox.askyesno("", "Bạn có muốn xóa classifier cũ để tạo classifier mới?")
		
		if answer:
			handleClassifier()
			messagebox.showinfo("DONE!", "Đã tạo thành công classifier")

	else:
		messagebox.showinfo("ERROR!!!", "Không tìm thấy file data.csv, hãy quét thư mục để xuất file trước!")



BtnXuLy = Button(window, text = "Xử lý csv", command = XuLyCSV)
BtnXuLy.grid(row = 1, column = 0)

def QuetVirus():
	if("classifier.pkl" in os.listdir("classifier") and "features.pkl" in os.listdir("classifier")):
		messagebox.showinfo("!!!", "Chọn 1 file bất kỳ để quét")
		filename = filedialog.askopenfilename()
		if(ScanVirus(filename) != 0):
			messagebox.showinfo("SAFE", "File an toàn")
		else:
			messagebox.showinfo("WARNING!!!!", "FILE khả nghi có thể là mã độc")

	else:
		messagebox.showinfo("ERROR!!!", "File classifier không tồn tại hoặc bị thiếu, hãy xử lý CSV trước!")



BtnQuetVirus = Button(window, text = "Quét virus trong file", command = QuetVirus)
BtnQuetVirus.grid(row = 2, column = 0)
#scrollbar = Scrollbar(window)
#listFile = Listbox(window)


#listFile.insert(1, "index")

#listFile.grid(row = 5, column = 0)

#BtnRaCsv = Button(window, text = "Xuất các file ra file csv", command = BtnRaCsvAction)
#BtnRaCsv.grid(row = 3, colunm = 0 )



#window.iconbitmap("Icon_Emoji_Raiden_Shogun_4.ico")

window.mainloop()

