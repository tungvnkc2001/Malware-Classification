from tkinter import *
#from turtle import left

from tkinter import *
import os
from tkinter import messagebox


from main import createRawCSV
from main import get_file
from tkinter import Tk, filedialog
from main import scanFolder
from PIL import ImageTk, Image

from XuLy import handleClassifier
from XuLy import ScanVirus

#from data_Malware.action import creBtnasd





top = Tk()
top.geometry("850x500")
top.title("Quét mã độc trên file PE trên window")

label_ThongBaoMoThuMuc = Label(top, text = "")
label_ThongBaoMoThuMuc.place(x = 100, y = 230)

label_trangThai = Label(top, text = "Trạng thái: waiting")
label_trangThai.place(x = 100, y = 250)

listFile = listFile = Listbox(top, height=12, width = 100)
listFile.place(x = 100, y = 30)

#xdt = Label(top, text = "").place(x = 30, y = 50)
def BtnQuetClick():
    folder = filedialog.askdirectory()
    if os.path.isdir(folder):
        label_ThongBaoMoThuMuc.configure(text = "Mở Folder thành công")
        label_ThongBaoMoThuMuc.place(x = 100, y = 230)

        listFile = listFile = Listbox(top, height=12, width = 100)
        listFile.place(x = 100, y = 30)
        i = 1
        for filename in os.listdir(folder):
            listFile.insert(i, "file: " + str(filename))


        answer = messagebox.askyesno("", "Bạn có muốn bắt đầu phân tích và lưu thông tin của file trong folder " + folder + " ?" )

        if answer:
            if("data.csv" not in os.listdir(os.getcwd())):
                answer = messagebox.askyesno("", "Không tìm được file data.csv để lưu dữ liệu, tạo file mới?")
                if answer:
                    createRawCSV()
                else:
                    return

            for file_name in os.listdir(folder):
                #state = "Trạng thái: đang scan: " + os.path.join(folder, file_name) 
                #label_trangThai.configure(text = state)
                #label_trangThai.grid(row = 0, column = 1)

                #print(os.path.isdir(os.path.join(folder, file_name)))
                if os.path.isdir(os.path.join(folder, file_name)):
                    scanFolder(os.path.join(folder, file_name))
                    #print("scan folder " + file_name)
                else:
                    get_file(os.path.join(folder, file_name))
                #get_file(os.path.join(folder, file_name))

                state = "Trạng thái: Đã scan xong " + folder
                label_trangThai.configure(text = state)

    else:
        label_ThongBaoMoThuMuc.configure(text = "Folder Không tồn tại")

xdt = Button(top, text = "Xuất đặc trưng",padx=20,pady=15, command = BtnQuetClick)
xdt.place(x =50, y=300)

qtf = Button(top, text = "Quét trên folder",padx=20,pady=15)
qtf.place(x =225, y=300)



def QuetVirus():
    if("classifier.pkl" in os.listdir("classifier") and "features.pkl" in os.listdir("classifier")):
        messagebox.showinfo("!!!", "Chọn 1 file bất kỳ để quét")
        filename = filedialog.askopenfilename()
        if(ScanVirus(filename) == 2):
            messagebox.showinfo("ERROR", "File có thể không phải định dạng PE hoặc đã bị Pack, hãy unpack trước")
        
        elif(ScanVirus(filename) == 0):
            messagebox.showinfo("WARNING!!!!", "FILE khả nghi có thể là mã độc")
        
        elif(ScanVirus(filename) == 1):
            messagebox.showinfo("SAFE!", "FILE an toàn")
    else:
        messagebox.showinfo("ERROR!!!", "File classifier không tồn tại hoặc bị thiếu, hãy xử lý CSV trước!")
q1f = Button(top, text = "Quét 1 file",padx=20,pady=15, command = QuetVirus)
q1f.place(x =400, y=300)





def creBtn():
    messagebox.showinfo("CREDIT", "Bài tập chuyên đề cơ sở của nhóm 41\nThành viên nhóm:\n - Nguyễn Đăng Hưng - AT160136\n - Nguyễn Thanh Tùng - AT160159\n - Nguyễn Hoàng Việt - AT160159 \nGiảng viên hướng dẫn: Thầy Lê Đức Thuận")

credit = Button(top, text = "Credit",padx=20,pady=15, command = creBtn)
credit.place(x =750, y=300)







def XuLyCSV():
    if "data.csv" in (os.listdir(os.getcwd())):
        answer = messagebox.askyesno("", "Bạn có muốn xóa classifier cũ để tạo classifier mới?")
        
        if answer:
            handleClassifier()
            messagebox.showinfo("DONE!", "Đã tạo thành công classifier")

    else:
        messagebox.showinfo("ERROR!!!", "Không tìm thấy file data.csv, hãy quét thư mục để xuất file trước!")
xl = Button(top, text = "Xử lý CSV",padx=20,pady=15, command = XuLyCSV)
xl.place(x =50, y=400)






CheckVar_random_forest = IntVar()
C1 = Checkbutton(top, text = "RANDOM FOREST", variable = CheckVar_random_forest, \
                 onvalue = 1, offvalue = 0, height=5, \
                 width = 20)
C1.place(x =200, y=400)


CheckVar_extra_tree = IntVar()
C2 = Checkbutton(top, text = "EXTRA TREE", variable = CheckVar_extra_tree, \
                 onvalue = 1, offvalue = 0, height=5, \
                 width = 20)
C2.place(x =300, y=400)


CheckVar_LABEL_1 = IntVar()
C3 = Checkbutton(top, text = "LABEL_1", variable = CheckVar_LABEL_1, \
                 onvalue = 1, offvalue = 0, height=5, \
                 width = 20)
C3.place(x =400, y=400)




CheckVar_LABEL_2 = IntVar()
C4 = Checkbutton(top, text = "LABEL_2", variable = CheckVar_LABEL_2, \
                 onvalue = 1, offvalue = 0, height=5, \
                 width = 20)
C4.place(x =500, y=400)



top.iconbitmap("Icon_Emoji_022_Mona_Hehe (1).ico")
top.mainloop()