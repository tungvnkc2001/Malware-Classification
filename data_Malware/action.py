from tkinter import *
#from turtle import left

from tkinter import *
import os
from tkinter import messagebox


from main import createRawCSV
from main import get_file
from tkinter import Tk, filedialog
from main import scanFolder
from PIL import ImageTk, Image

from XuLy import handleClassifier
from XuLy import ScanVirus
 
from action import *

def creBtn():
	messagebox.showinfo("CREDIT", "Bài tập chuyên đề cơ sở của nhóm 41\nThành viên nhóm:\n - Nguyễn Đăng Hưng - AT160136\n - Nguyễn Thanh Tùng - AT\n - Nguyễn Hoàng Việt - AT \nGiảng viên hướng dẫn: Thầy Lê Đức Thuận")




def BtnQuetClick():
	folder = filedialog.askdirectory()
	if os.path.isdir(folder):
		#label_ThongBaoMoThuMuc.configure(text = "Mở Folder thành công")
		#label_ThongBaoMoThuMuc.grid(row = 5, column = 1)

		listFile = listFile = Listbox(window, height=12, width = 100)
		listFile.place(x = 100, y = 30)
		i = 1
		for filename in os.listdir(folder):
			listFile.insert(i, filename)


		answer = messagebox.askyesno("", "Bạn có muốn bắt đầu phân tích và lưu thông tin của file trong folder " + folder + " ?" )

		if answer:
			if("data.csv" not in os.listdir(os.getcwd())):
				answer = messagebox.askyesno("", "Không tìm được file data.csv để lưu dữ liệu, tạo file mới?")
				if answer:
					createRawCSV()
				else:
					return

			for file_name in os.listdir(folder):
				#state = "Trạng thái: đang scan: " + os.path.join(folder, file_name) 
				#label_trangThai.configure(text = state)
				#label_trangThai.grid(row = 0, column = 1)

				#print(os.path.isdir(os.path.join(folder, file_name)))
				if os.path.isdir(os.path.join(folder, file_name)):
					scanFolder(os.path.join(folder, file_name))
					#print("scan folder " + file_name)
				else:
					get_file(os.path.join(folder, file_name))
				#get_file(os.path.join(folder, file_name))

				state = "Trạng thái: Đã scan xong " + folder
				label_trangThai.configure(text = state)

	else:
		label_ThongBaoMoThuMuc.configure(text = "Folder Không tồn tại")




def XuLyCSV():
	if "data.csv" in (os.listdir(os.getcwd())):
		answer = messagebox.askyesno("", "Bạn có muốn xóa classifier cũ để tạo classifier mới?")
		
		if answer:
			handleClassifier()
			messagebox.showinfo("DONE!", "Đã tạo thành công classifier")

	else:
		messagebox.showinfo("ERROR!!!", "Không tìm thấy file data.csv, hãy quét thư mục để xuất file trước!")


def QuetVirus():
	if("classifier.pkl" in os.listdir("classifier") and "features.pkl" in os.listdir("classifier")):
		messagebox.showinfo("!!!", "Chọn 1 file bất kỳ để quét")
		filename = filedialog.askopenfilename()
		if(ScanVirus(filename) == 2):
			messagebox.showinfo("ERROR", "File có thể không phải định dạng PE hoặc đã bị Pack, hãy unpack trước")
		
		elif(ScanVirus(filename) == 0):
			messagebox.showinfo("WARNING!!!!", "FILE khả nghi có thể là mã độc")
		
		else:
			messagebox.showinfo("SAFE!", "FILE an toàn")
	else:
		messagebox.showinfo("ERROR!!!", "File classifier không tồn tại hoặc bị thiếu, hãy xử lý CSV trước!")